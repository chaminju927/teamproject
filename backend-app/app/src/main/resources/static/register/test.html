<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      /* 검증 후에만 :invalid 스타일을 적용한다 */
      form.was-validated input:invalid {
        border-color: red;
      }
    </style>
  </head>
  <body>
    <form action="register" id="doctors-register-form" method="post">
      <label for="id-input">ID:</label>
      <input type="text" id="id-input" name="id" required />
      <button type="button" id="check-duplicate-btn">중복확인</button>
      <div id="message"></div>
      <label>비밀번호:</label>
      <input
        type="password"
        name="password"
        placeholder="최소 8자 이상 문자, 숫자, 특수 문자를 포함하여 작성하세요."
        pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[$@$!%*#?&])[A-Za-z\d$@$!%*#?&]{8,}$"
        required
      /><br />
      <label>이름:</label>
      <input type="text" name="name" required /><br />

      <label>생년월일:</label>
      <input type="date" name="birth" required /><br />
      <div>
        <label for="email-id">이메일 주소</label>
        <input type="text" id="email-id" name="email" required />
        @
        <select id="email-domain" required>
          <option value="">이메일 도메인을 선택하세요</option>
          <option value="naver.com">naver.com</option>
          <option value="gmail.com">gmail.com</option>
          <option value="daum.net">daum.net</option>
          <option value="직접입력">직접입력</option>
        </select>
        <input type="text" id="email-direct" style="display: none" />
      </div>
      <input type="submit" value="가입하기" id="btn-insert" />
    </form>
    <script>
      // 유효성 검사 기본
      document.querySelectorAll('input').forEach((input) => {
        input.addEventListener('invalid', () => {
          // 검증 후 폼 요소에 was-validated 클래스로 표시해 둔다
          document.forms[0].classList.add('was-validated');
        });
      });

      // 오류 메세지 사전을 만든다
      const validityMessage = {
        badInput: '[커스텀 메세지] 잘못된 입력입니다.',
        patternMismatch: '[커스텀 메세지] 패턴에 맞게 입력하세요',
        rangeOverflow: '[커스텀 메세지] 범위를 초과하였습니다',
        rangeUnderflow: '[커스텀 메세지] 범위에 미달하였습니다',
        stepMismatch: '[커스텀 메세지] 간격에 맞게 입력하세요',
        tooLong: '[커스텀 메세지] 최대 글자 미만으로 입력하세요',
        tooShort: '[커스텀 메세지] 최소 글자 미만으로 입력하세요',
        typeMismatch: '[커스텀 메세지] 형식에 맞게 입력하세요',
        valueMissing: '[커스텀 메세지] 이 필드를 반드시 입력하세요',
      };

      // validity 객체를 받아 메세지 맵에서 오류 메세지를 찾는다
      function getMessage(validity) {
        for (const key in validityMessage) {
          if (validity[key]) {
            return validityMessage[key];
          }
        }
      }

      const form = document.querySelector('#doctors-register-form');
      const idInput = document.querySelector('#id-input');
      const messageDiv = document.querySelector('#message');
      const checkDuplicateBtn = document.querySelector('#check-duplicate-btn');
      let isDuplicate = true;

      const emailIdInput = document.querySelector('#email-id');
      const emailDomainSelect = document.querySelector('#email-domain');
      const emailDirectInput = document.querySelector('#email-direct');

      // ID 중복 확인 버튼 클릭 이벤트
      checkDuplicateBtn.onclick = () => {
        const id = idInput.value;

        fetch(`../doctors/check-duplicate?id=${id}`)
          .then((response) => response.json())
          .then((result) => {
            if (result.status === 'FAILURE') {
              messageDiv.textContent = result.message;
              isDuplicate = true;
            } else {
              messageDiv.textContent = result.message;
              isDuplicate = false;
            }
          })
          .catch((exception) => {
            console.error('ID 중복 확인 중 오류 발생:', exception);
            messageDiv.textContent = '오류가 발생했습니다. 다시 시도해주세요.';
          });
      };

      emailIdInput.addEventListener('input', updateEmailValue);
      emailDomainSelect.addEventListener('change', updateEmailValue);

      function updateEmailValue() {
        const emailId = emailIdInput.value;
        const emailDomain = emailDomainSelect.value;
        let emailValue = '';

        if (emailId !== '' && emailDomain !== '직접입력') {
          emailDirectInput.style.display = 'none';
          emailDirectInput.required = false;
          emailDirectInput.removeAttribute('pattern');
          emailValue = `${emailId}@${emailDomain}`;
        } else if (emailId !== '' && emailDomain === '직접입력') {
          emailDirectInput.style.display = 'inline-block';
          emailDirectInput.required = true;
          emailDirectInput.pattern =
            "^([!#-'*+/-9=?A-Z^-~-]+(\.[!#-'*+/-9=?A-Z^-~-]+)*|\[[\t -Z^-~]*])";
          emailValue = `${emailId}@${emailDirectInput.value}`;
        }

        emailIdInput.setAttribute('value', emailValue);
        return emailValue;
      }

      document.querySelector('#btn-insert').onclick = () => {
        if (isDuplicate) {
          messageDiv.textContent = 'ID를 중복 확인하세요.';
          return;
        }
        const formData = new FormData(form);

        const emailValue = updateEmailValue();
        formData.set('email', emailValue);

        if (form.checkValidity()) {
          let json = JSON.stringify(Object.fromEntries(formData));

          fetch('../doctors', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: json,
          })
            .then((response) => response.json())
            .then((result) => {
              if (result.status == 'success') {
                location.reload();
                console.log('성공:', data);
              } else {
                alert('입력실패');
                console.log(result.data);
              }
            })
            .catch((exception) => {
              alert('입력 중 오류 발생');
              console.log(exception);
              console.error('실패:', error);
            });
        } else {
          form.reportValidity();
        }
      };
    </script>
  </body>
</html>
